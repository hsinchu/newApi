# 接口修复说明

## 问题描述

用户报告 `/api/bet/getMaxBetAmount` 接口返回错误：
```json
{
  "code": 0,
  "msg": "获取最大投注额失败：",
  "time": 1754295463,
  "data": []
}
```

请求参数：
- lottery_code: ff3d
- period: 2508040978  
- play_type: da
- odds: 3

## 问题分析

通过代码分析发现两个关键问题：

### 1. 赔率验证类型转换问题

**问题位置**：`LotteryBetService::validateOdds()` 方法

**问题原因**：
- 数据库中 `fa_lottery_bonus.bonus_json` 字段存储的是字符串数组：`["2","3","3.5","5"]`
- 用户传入的 `odds` 参数是数字类型：`3`
- `in_array(3, ["2","3","3.5","5"])` 返回 `false`（严格类型比较）

**修复方案**：
```php
// 修复前
return in_array($odds, $bonusJson);

// 修复后  
$numericOdds = array_map('floatval', $bonusJson);
return in_array((float)$odds, $numericOdds);
```

### 2. 奖金池单位转换问题

**问题位置**：`Bet::updateBonusPool()` 方法

**问题原因**：
- 投注金额使用分为单位
- `fa_lottery_type.bonus_pool` 字段使用元为单位
- 更新时未进行单位转换

**修复方案**：
```php
// 修复前
$bonusPoolAmount = $totalAmount * 0.8;

// 修复后
$bonusPoolAmountInFen = $totalAmount * 0.8;
$bonusPoolAmountInYuan = $bonusPoolAmountInFen / 100; // 转换为元
```

## 修复内容

### 1. 修复赔率验证逻辑

**文件**：`api/app/service/LotteryBetService.php`

**修改内容**：
- 在 `validateOdds()` 方法中添加类型转换
- 将数组中的字符串值转换为浮点数进行比较
- 同时处理数组和对象格式的赔率数据

### 2. 修复奖金池单位转换

**文件**：`api/app/api/controller/Bet.php`

**修改内容**：
- 在 `updateBonusPool()` 方法中添加单位转换
- 投注金额（分）→ 奖金池增加额（元）
- 更新日志记录，明确显示单位

## 测试验证

创建了测试脚本 `test_max_bet_fix.php` 验证修复逻辑：

1. **赔率验证测试**：
   - 修复前：`in_array(3, ['2','3','3.5','5'])` = `false`
   - 修复后：`in_array(3.0, [2.0,3.0,3.5,5.0])` = `true`

2. **单位转换测试**：
   - 投注100元（10000分）
   - 修复前：奖金池增加8000分（错误）
   - 修复后：奖金池增加80元（正确）

## 影响范围

1. **直接影响**：
   - `/api/bet/getMaxBetAmount` 接口现在可以正常工作
   - 赔率验证逻辑更加健壮
   - 奖金池更新单位正确

2. **间接影响**：
   - 所有使用 `validateOdds()` 方法的功能
   - 所有涉及奖金池更新的投注流程

## 注意事项

1. **数据库字段单位**：
   - `fa_lottery_type.bonus_pool`：元
   - 投注相关金额字段：分
   - 需要注意单位转换

2. **赔率数据格式**：
   - 数据库存储可能是字符串数组或对象
   - 验证时统一转换为数值类型

3. **向后兼容性**：
   - 修复保持了原有接口的兼容性
   - 不影响现有功能的正常使用

## 修复时间

修复完成时间：2025年1月15日

## 相关文件

- `api/app/service/LotteryBetService.php`
- `api/app/api/controller/Bet.php`
- `test_max_bet_fix.php`（测试文件）
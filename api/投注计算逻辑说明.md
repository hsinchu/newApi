# 3D彩票投注计算逻辑说明

## 概述

本文档详细说明了3D彩票游戏的投注计算逻辑，包括奖金池管理、最大投注额计算等核心功能。

## 游戏规则

### 基础设置
- **基础奖金池**：10,000元（不能赔出去，仅用于显示）
- **服务费率**：20%
 **平台盈利率**：20%
- **奖金池构成**：基础奖金池 + 累计奖金池

### 奖金池管理机制
- 基础奖金池10000元不参与实际赔付，仅作为显示用途
- 每笔投注扣除20%服务费后，剩余80%进入累计奖金池
- 累计奖金池存储在数据库`fa_lottery_type.bonus_pool`字段中
- 显示的总奖金池 = 基础奖金池10000 + 累计奖金池
- 实际可用于赔付的资金 = 累计奖金池金额

### 奖金池更新机制
- 投注成功后立即更新彩种表的`bonus_pool`字段
- 更新方式：累加投注金额的80%到现有奖金池
- 更新时机：在投注订单创建成功、事务提交后执行
- 异常处理：更新失败时记录日志，不影响投注流程

### 玩法类型
3D游戏针对和值提供三种玩法：

1. **大（da）**：和值19-28
   - 可选赔率：2.5, 3.8, 5.5, 8.0

2. **和（he）**：和值9-18
   - 可选赔率：1.3, 1.5, 1.8, 2.2

3. **小（xiao）**：和值0-8
   - 可选赔率：2.0, 3.5, 5.0, 7.5

## 投注计算逻辑

### 1. 奖金池计算

```
当前奖金池 = 基础奖金池(10000) + 当期总投注额 × 80%
```

**示例**：
- 当期总投注额：5000元
- 当前奖金池：10000 + 5000 × 0.8 = 14000元
- 可用于赔付：5000 × 0.8 = 4000元（基础奖金池不能赔出去）

### 2. 系统最大投注额计算

系统需要保证两个约束条件：

#### 约束1：中奖赔付不超过可用资金
```
新投注额 × 赔率 ≤ 可用资金 + 新投注额 × 0.8 - 当前最大可能赔付
```

解得：
```
新投注额 ≤ (可用资金 - 当前最大可能赔付) / (赔率 - 0.8)
```

#### 约束2：平台保持盈利
```
(可用资金 + 新投注额 × 0.8) × (1 - 盈利率) ≥ 新投注额 × 赔率
```

解得：
```
新投注额 ≤ 可用资金 × (1 - 盈利率) / (赔率 - 0.8 × (1 - 盈利率))
```

**最终系统限制** = min(约束1结果, 约束2结果)

### 3. 用户最大投注额计算

用户中奖金额不能大于其总投注额（扣除服务费）：

```
新投注额 × 赔率 ≤ (用户总投注额 + 新投注额) × (1 - 服务费率)
```

解得：
```
用户最大投注额 = 用户总投注额 × (1 - 服务费率) / (赔率 - (1 - 服务费率))
```

### 4. 最终最大投注额

```
最终最大投注额 = min(系统最大投注额, 用户最大投注额)
```

## 计算示例

### 场景1：初始状态
- 当期总投注额：0元
- 用户总投注额：0元
- 玩法：大，赔率：2.5

**计算过程**：
1. 可用资金：0 × 0.8 = 0元
2. 当前最大可能赔付：0元
3. 约束1：(0 - 0) / (2.5 - 0.8) = 0元
4. 约束2：0 × 0.8 / (2.5 - 0.8 × 0.8) = 0元
5. 系统限制：0元
6. 用户限制：0 × 0.8 / (2.5 - 0.8) = 0元
7. **最终限制：0元**

### 场景2：有投注基础
- 当期总投注额：10000元
- 用户总投注额：1000元
- 玩法：和，赔率：1.8

**计算过程**：
1. 可用资金：10000 × 0.8 = 8000元
2. 当前最大可能赔付：假设为2000元
3. 约束1：(8000 - 2000) / (1.8 - 0.8) = 6000元
4. 约束2：8000 × 0.8 / (1.8 - 0.8 × 0.8) = 5333.33元
5. 系统限制：5333.33元
6. 用户限制：1000 × 0.8 / (1.8 - 0.8) = 800元
7. **最终限制：800元**

## 风险控制

### 1. 奖金池保护
- 基础奖金池10000元永远不能用于赔付
- 只有当期投注扣除服务费后的资金可用于赔付

### 2. 平台盈利保障
- 通过盈利率约束确保平台始终有20%的盈利空间
- 考虑最坏情况（最高赔率玩法中奖）进行计算

### 3. 用户投注限制
- 单个用户的中奖金额不能超过其投注总额扣除服务费
- 防止用户通过高赔率获得超额收益

## 技术实现

### 核心方法

1. **calculateMaxBetAmount()** - 主计算方法
   - 获取奖金池信息
   - 计算系统和用户限制
   - 返回最终最大投注额

2. **calculateSystemMaxBet()** - 系统最大投注额计算
   - 考虑奖金池限制
   - 考虑平台盈利要求
   - 考虑最坏赔付场景

3. **calculateUserMaxBet()** - 用户最大投注额计算
   - 基于用户已投注金额
   - 确保中奖不超过净投注额

4. **getCurrentBonusPool()** - 奖金池获取
   - 从数据库获取累计奖金池
   - 计算总奖金池（基础+累计）

5. **getMaxOddsForPlayType()** - 获取玩法最高赔率
   - 支持大/小/和三种玩法
   - 返回对应的最高赔率值

6. **updateBonusPool()** - 奖金池更新
   - 投注成功后更新累计奖金池
   - 计算并累加80%投注金额
   - 记录更新日志

### 数据库表

- **fa_lottery_type**: 彩种配置表
  - `bonus_pool`: 累计奖金池金额（分为单位）
  - `type_code`: 彩种代码
  - `type_name`: 彩种名称

- **fa_bet_order**: 投注订单表
  - `total_amount`: 投注总金额（分为单位）
  - `lottery_code`: 彩种代码
  - `period_no`: 期号
  - `user_id`: 用户ID

- **fa_lottery_bonus**: 赔率配置表
  - `lottery_id`: 彩种ID
  - `type_key`: 玩法键名（da/he/xiao）
  - `bonus_json`: 赔率配置JSON

## 注意事项

1. **实时计算**：每次投注前都需要重新计算最大投注额
2. **并发控制**：高并发情况下需要考虑数据一致性
3. **异常处理**：计算过程中的异常情况需要妥善处理
4. **日志记录**：重要的计算过程应该记录日志便于审计
5. **基础奖金池保护**: 10000元基础奖金池不参与赔付计算，确保平台基础展示
6. **服务费固定**: 20%服务费率不可调整，确保平台收入稳定
7. **盈利率保障**: 20%平台盈利率确保平台可持续运营
8. **赔率动态**: 支持多档赔率配置，可根据市场调整
9. **用户限制**: 防止用户过度投注，保护用户资金安全
10. **系统限制**: 防止平台承担过高风险，确保资金安全
11. **奖金池实时性**: 投注成功后立即更新奖金池，确保数据实时准确
12. **数据一致性**: 奖金池更新在事务外执行，失败不影响投注流程
13. **金额单位**: 所有计算以分为单位，显示时转换为元，避免精度问题
14. **异常处理**: 奖金池更新异常时记录详细日志，便于问题排查

## 测试验证

使用 `test_bet_calculation.php` 文件可以验证计算逻辑的正确性，包括：
- 奖金池计算验证
- 赔率配置验证
- 不同场景下的最大投注额计算验证